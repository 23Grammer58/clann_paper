# Математическое описание CLANN (Convex Laplace Artificial Neural Network)

## 1. Введение и физические основы

CLANN представляет собой нейросетевую модель для описания гиперупругого поведения материалов в рамках нелинейной механики сплошных сред. Модель основана на принципах:

- **Гиперупругость**: материал описывается через функцию плотности энергии деформации $\psi$
- **Выпуклость**: гарантирует физическую корректность и стабильность решения
- **Инвариантность**: модель инвариантна относительно поворотов

## 2. Кинематические соотношения

### 2.1 Тензоры деформации

В CLANN используются следующие тензоры:

- **Тензор градиента деформации** $F$: описывает локальную деформацию
- **Тензор правого Коши-Грина** $C = F^T F$: мера деформации, инвариантная к поворотам
- **Верхнетреугольный фактор Холецкого** $U$: $C = U^T U$

### 2.2 Параметризация через $\xi$

Ключевая идея CLANN - параметризация через логарифмические координаты:

$$\xi_1 = \ln(u_{11}), \quad \xi_2 = \ln(u_{22}), \quad \xi_3 = \frac{u_{12}}{u_{11}}$$

где $u_{ij}$ - компоненты матрицы $U$.

**Преимущества такой параметризации:**
- Обеспечивает выпуклость функции энергии
- Упрощает вычисление производных
- Позволяет корректно обрабатывать большие деформации

## 3. Архитектура нейронной сети

### 3.1 ICNN (Input Convex Neural Network)

CLANN использует строго выпуклую нейронную сеть:

```python
class ICNN1(nn.Module):
    def forward(self, xi):
        z = F.softplus(β * W₁(xi)) / β
        ψ = W₂^T z + b₂
```

где:
- $W_1 \in \mathbb{R}^{H \times 3}$ - матрица весов первого слоя
- $W_2 \in \mathbb{R}^H_+$ - неотрицательные веса второго слоя (обеспечивают выпуклость)
- $\beta$ - параметр сглаживания (при $\beta \to \infty$ получаем ReLU)

### 3.2 Математическое обоснование выпуклости

Функция $\psi(\xi)$ строго выпукла, поскольку:
1. $\text{softplus}(\beta x)/\beta$ - выпуклая функция
2. Композиция выпуклой функции с линейным отображением выпукла
3. Линейная комбинация с неотрицательными весами сохраняет выпуклость

## 4. Вычисление напряжений

### 4.1 Основное соотношение

Напряжения вычисляются как производные энергии по деформации:

$$S = \frac{\partial \psi}{\partial C}$$

### 4.2 Цепное правило дифференцирования

Поскольку $\psi = \psi(\xi(C))$, применяем цепное правило:

$$\frac{\partial \psi}{\partial C} = \frac{\partial \psi}{\partial \xi} \cdot \frac{\partial \xi}{\partial C}$$

### 4.3 Явные формулы для компонент

В коде реализованы следующие соотношения:

```python
def S_from_xi(g, xi, U):
    s11 = exp(-2*xi[0]) * (g[0] - 2*xi[2]*g[2]) + exp(-2*xi[1]) * g[1] * xi[2]^2
    s22 = exp(-2*xi[1]) * g[1]
    s12 = -exp(-2*xi[1]) * g[1] * xi[2] + exp(-2*xi[0]) * g[2]
```

где $g_i = \frac{\partial \psi}{\partial \xi_i}$.

## 5. Вычисление гессиана

### 5.1 Матрица жёсткости

Для решения методом Ньютона требуется гессиан:

$$H_{ij} = \frac{\partial^2 \psi}{\partial \xi_i \partial \xi_j}$$

### 5.2 Аналитическое вычисление

В `HessianWrapper1L` реализовано аналитическое вычисление:

```python
def forward(self, xi):
    s = W₁ @ xi + b₁
    σ = sigmoid(β * s)
    σ' = β * σ * (1 - σ)
    
    H_ij = Σ_h σ'_h * w2_h * W_hi * W_hj
```

## 6. Функция потерь и обучение

### 6.1 Основная функция потерь

$$L = \frac{1}{N} \sum_{i=1}^N \|S_{pred}^{(i)} - S_{exp}^{(i)}\|^2$$

где $S_{pred}$ и $S_{exp}$ - предсказанные и экспериментальные напряжения.

### 6.2 Дополнительные слагаемые

#### 6.2.1 Якорь при единичной деформации
$$L_{SI} = \|S(I)\|^2$$

Гарантирует, что при отсутствии деформации ($C = I$) напряжения равны нулю.

#### 6.2.2 Якорь производных при нулевой деформации
$$L_{d\psi} = \|\nabla_\xi \psi(0)\|^2$$

#### 6.2.3 Нормировка энергии
$$L_{\psi} = \|\psi(0)\|^2$$

### 6.3 Полная функция потерь

$$L_{total} = L + \lambda_{SI} L_{SI} + \lambda_{d\psi} L_{d\psi} + \lambda_{\psi} L_{\psi}$$

## 7. Математические свойства

### 7.1 Физическая корректность

1. **Объективность**: модель инвариантна относительно поворотов
2. **Выпуклость**: гарантирует единственность решения
3. **Положительность энергии**: $\psi \geq 0$ для всех допустимых деформаций

### 7.2 Стабильность

- Строгая выпуклость обеспечивает стабильность численного решения
- Гессиан положительно определён, что гарантирует сходимость метода Ньютона

### 7.3 Асимптотическое поведение

При малых деформациях модель воспроизводит линейную упругость:
- $S \approx 2\mu \varepsilon$ для малых $\varepsilon$
- $H \approx \text{const}$ в окрестности $C = I$

## 8. Термодинамическая корректность

### 8.1 Основные принципы термодинамики

CLANN обеспечивает термодинамическую корректность через **прямое вычисление напряжений из дифференцирования функции энергии** - это фундаментальный принцип гиперупругой механики.

#### 8.1.1 Первый закон термодинамики (сохранение энергии)
Модель основана на концепции потенциальной энергии деформации $\psi$, что автоматически обеспечивает:
- Сохранение энергии в замкнутых системах
- Обратимость деформаций (гиперупругость)
- Отсутствие диссипации энергии

**Ключевой механизм**: все напряжения вычисляются как производные энергии:
$$S = \frac{\partial \psi}{\partial C}$$

Это гарантирует, что работа напряжений при любом замкнутом цикле деформации равна нулю, что является прямым следствием первого закона термодинамики.

#### 8.1.2 Второй закон термодинамики (рост энтропии)
В рамках гиперупругой модели второй закон выполняется автоматически, поскольку:
- Процесс деформации квазистатический
- Отсутствуют необратимые процессы
- Энергия полностью определяется текущим состоянием деформации

### 8.2 Механизмы обеспечения термодинамической корректности

#### 8.2.1 Прямое вычисление напряжений из энергии

**Фундаментальный принцип**: термодинамическая корректность достигается через строгое соблюдение соотношений гиперупругой механики:

1. **Определение напряжений через энергию**:
   $$S = \frac{\partial \psi}{\partial C}$$
   
   Это соотношение является прямым следствием первого закона термодинамики и гарантирует, что:
   - Напряжения являются консервативными силами
   - Работа напряжений не зависит от пути деформации
   - Энергия полностью восстанавливается при разгрузке

2. **Цепное правило дифференцирования**:
   Поскольку $\psi = \psi(\xi(C))$, применяем:
   $$\frac{\partial \psi}{\partial C} = \frac{\partial \psi}{\partial \xi} \cdot \frac{\partial \xi}{\partial C}$$
   
   где $\frac{\partial \psi}{\partial \xi}$ вычисляется через нейронную сеть, а $\frac{\partial \xi}{\partial C}$ - аналитически.

3. **Симметрия напряжений**:
   $$S_{ij} = S_{ji}$$
   
   Автоматически обеспечивается симметрией тензора $C$ и соответствующими производными.

#### 8.2.2 Выпуклость функции энергии

**Дополнительный механизм**: строгая выпуклость $\psi(\xi)$ обеспечивает:

1. **Положительность модулей упругости**:
   $$H_{ij} = \frac{\partial^2 \psi}{\partial \xi_i \partial \xi_j} > 0$$
   
   Это гарантирует, что при увеличении деформации энергия растёт быстрее линейной функции.

2. **Стабильность равновесия**:
   - Любое локальное равновесие является глобальным минимумом
   - Отсутствие бифуркаций и катастроф
   - Устойчивость к малым возмущениям

3. **Монотонность напряжений**:
   $$\frac{\partial S}{\partial C} = \frac{\partial^2 \psi}{\partial C^2} > 0$$
   
   Обеспечивает физически корректное поведение: увеличение деформации приводит к увеличению напряжений.

#### 8.2.3 Логарифмическая параметризация

Параметризация $\xi = \ln(U)$ обеспечивает:

1. **Корректное поведение при больших деформациях**:
   - Логарифм естественным образом ограничивает рост энергии
   - Предотвращает нефизичные значения при экстремальных деформациях

2. **Инвариантность относительно масштабирования**:
   $$\psi(\xi + c) = \psi(\xi) + \text{const}$$
   
   Энергия определена с точностью до аддитивной константы.

3. **Симметрия относительно сжатия/растяжения**:
   Логарифмическая параметризация обеспечивает симметричное поведение при сжатии и растяжении.

#### 8.2.4 Якорные условия

Дополнительные слагаемые в функции потерь обеспечивают:

1. **Нормировка энергии**:
   $$L_{\psi} = \|\psi(0)\|^2 \Rightarrow \psi(0) = 0$$
   
   Энергия в недеформированном состоянии равна нулю.

2. **Нулевые напряжения в равновесии**:
   $$L_{SI} = \|S(I)\|^2 \Rightarrow S(I) = 0$$
   
   При отсутствии деформации напряжения равны нулю.

3. **Стабильность в равновесии**:
   $$L_{d\psi} = \|\nabla_\xi \psi(0)\|^2 \Rightarrow \nabla_\xi \psi(0) = 0$$
   
   Недеформированное состояние является критической точкой энергии.

#### 8.2.5 Развёрнутый вывод через цепное правило и соответствие коду

Пусть полная потенциальная энергия деформации задаётся композиционно
\[ \Psi(C) = \psi(\xi(C)) ,\quad C = F^\top F,\quad C = U^\top U,\ \xi = (\ln u_{11},\ln u_{22}, u_{12}/u_{11}). \]

Тензор ПК2 определяется как
\[ S = \frac{\partial \Psi}{\partial C}. \]
Применяя цепное правило к \(\Psi(C)\), получаем эквивалентную запись
\[ \frac{\partial \Psi}{\partial C} = \frac{\partial \psi}{\partial \xi} : \frac{\partial \xi}{\partial C} \equiv g(\xi) : J(C), \]
где \(g(\xi) = \partial\psi/\partial\xi\in\mathbb{R}^3\) и \(J(C)=\partial\xi/\partial C\) — тензор Якоби.

В размерности 2D при выбранной параметризации \(\xi\) и разложении Холецкого \(C=U^\top U\) аналитическая подстановка даёт явные формулы для компонент \(S\) (см. § 4.3):
\[\begin{aligned}
S_{11} &= e^{-2\xi_1}\big(g_1-2\xi_3 g_3\big) + e^{-2\xi_2}\,g_2\,\xi_3^2,\\
S_{22} &= e^{-2\xi_2}\,g_2,\\
S_{12} &= -e^{-2\xi_2}\,g_2\,\xi_3 + e^{-2\xi_1}\,g_3.
\end{aligned}\]

Тем самым, вычисление \(S\) через \(g\,J\) полностью эквивалентно «прямому» \(\partial\Psi/\partial C\) и обеспечивает гиперупругость (консервативность) поля напряжений: \(\exists\,\Psi: S=\partial\Psi/\partial C\Rightarrow \oint S:dC=0\).

Практическое соответствие коду: сначала вычисляется \(g=\partial\psi/\partial\xi\) автодифференцированием по \(\xi\), затем применяется аналитическая формула выше (функция `S_from_xi`), что реализует умножение на \(J=\partial\xi/\partial C\).

Альтернативный, эквивалентный путь — сначала получить \(\Sigma=\partial\psi/\partial U\) и восстановить \(S\) из уравнения Сильвестра \(S U^\top + U S = 2\,\Sigma\) (см. `sylv_symm_upper`), что также следует из цепного правила через связку \(C=U^\top U\).

Предпосылки корректности: \(C\) — SPD (корректность \(U\) и логарифмов), \(\psi\) — скалярный потенциал (\(g\) — истинный градиент), зависимость только от \(C\) (объективность).

### 8.3 Термодинамические ограничения

#### 8.3.1 Положительность энергии
$$\psi(\xi) \geq 0 \quad \forall \xi \in \mathbb{R}^3$$

Обеспечивается через:
- Неотрицательные веса $W_2 \geq 0$
- Положительность функции активации $\text{softplus}(x) \geq 0$

#### 8.3.2 Рост энергии при деформации
$$\psi(\xi) \to \infty \quad \text{при} \quad \|\xi\| \to \infty$$

Гарантируется выпуклостью и логарифмической параметризацией.

#### 8.3.3 Симметрия напряжений
$$S_{ij} = S_{ji}$$

Обеспечивается симметрией тензора $C$ и соответствующими производными.

#### 8.3.4 Консервативность напряжений
Ключевое свойство: напряжения являются консервативными силами, поскольку они получены как градиент скалярной функции энергии:

$$\oint S : dC = 0$$

для любого замкнутого цикла деформации. Это прямое следствие того, что $S = \frac{\partial \psi}{\partial C}$.

### 8.4 Связь с классическими моделями

#### 8.4.1 Линейная упругость
При малых деформациях CLANN воспроизводит закон Гука:
$$S \approx 2\mu \varepsilon + \lambda \text{tr}(\varepsilon) I$$

где $\mu, \lambda$ - коэффициенты Ламе.

#### 8.4.2 Нелинейные модели
CLANN обобщает классические гиперупругие модели:
- **Модель Нео-Гука**: $\psi = \frac{\mu}{2}(I_1 - 3)$
- **Модель Муни-Ривлина**: $\psi = C_1(I_1 - 3) + C_2(I_2 - 3)$
- **Модель Огдена**: $\psi = \sum_{i=1}^N \frac{\mu_i}{\alpha_i}(\lambda_1^{\alpha_i} + \lambda_2^{\alpha_i} + \lambda_3^{\alpha_i} - 3)$

**Важно**: все эти классические модели также основаны на принципе $S = \frac{\partial \psi}{\partial C}$, что подтверждает термодинамическую корректность подхода CLANN.

### 8.5 Численная стабильность

Термодинамическая корректность обеспечивает:

1. **Сходимость метода Ньютона**:
   - Положительная определённость гессиана
   - Отсутствие сингулярностей

2. **Устойчивость временной интеграции**:
   - Сохранение энергии в консервативных схемах
   - Отсутствие численных неустойчивостей

3. **Корректность граничных условий**:
   - Автоматическое удовлетворение принципа виртуальной работы
   - Корректная передача напряжений через границы элементов

4. **Консервативность численной схемы**:
   - Работа напряжений при замкнутых циклах деформации равна нулю
   - Сохранение полной энергии системы

## 9. Численные аспекты

### 9.1 Разложение Холецкого

Используется для параметризации:
```python
def cholesky_upper(C):
    return torch.linalg.cholesky(C).transpose(-2, -1)
```

### 9.2 Автоматическое дифференцирование

PyTorch autograd используется для вычисления:
- $\nabla_\xi \psi$
- $\nabla_C \psi$ через цепное правило

### 9.3 ONNX экспорт

Для интеграции в FE-код используются специальные обёртки:
- `DerivWrapper1L`: вычисляет градиент без autograd
- `HessianWrapper1L`: вычисляет гессиан аналитически

## 10. Применение в биомеханике

### 10.1 Преимущества для мягких тканей

1. **Нелинейность**: корректно описывает нелинейное поведение биологических тканей
2. **Несжимаемость**: может быть учтена через ограничения
3. **Анизотропия**: может быть расширена для описания анизотропных материалов

### 10.2 Ограничения

1. **Изотропность**: базовая модель предполагает изотропный материал
2. **Гиперупругость**: не учитывает вязкоупругие эффекты
3. **Пластичность**: не моделирует необратимые деформации

## 11. Заключение

CLANN представляет собой математически строгую и физически корректную модель для описания гиперупругого поведения материалов. Использование выпуклых нейронных сетей и логарифмической параметризации обеспечивает:

- Гарантированную сходимость численных методов
- Физическую корректность предсказаний
- Эффективную интеграцию в FE-код
- **Термодинамическую корректность** через прямое вычисление напряжений из дифференцирования функции энергии

**Ключевой принцип**: термодинамическая корректность достигается не через дополнительные ограничения, а через строгое соблюдение фундаментального соотношения гиперупругой механики $S = \frac{\partial \psi}{\partial C}$. Это обеспечивает:

- Консервативность напряжений (работа при замкнутых циклах равна нулю)
- Независимость работы от пути деформации
- Полное восстановление энергии при разгрузке
- Автоматическое соблюдение законов термодинамики

Модель особенно подходит для моделирования мягких биологических тканей, где важны нелинейные эффекты и стабильность численного решения. Термодинамическая корректность делает CLANN особенно привлекательной для долгосрочных симуляций и критических приложений в биомеханике.